#!/usr/bin/env bash

# Commit message validation hook for wt-core
# Enforces Conventional Commits format (no scopes)
#
# Valid formats:
#   type: description
#   Merge pull request ...       (auto-generated merge commits)
#   fixup! / squash! / amend!    (interactive rebase commits)

set -e

RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Strip comment lines (lines starting with #)
MSG=$(echo "$COMMIT_MSG" | grep -v '^#' | head -1)

if [ -z "$MSG" ]; then
    echo -e "${RED}Error: Empty commit message.${NC}"
    exit 1
fi

# ── Allowed bypasses ─────────────────────────────────────────────────

# Allow merge commits
if echo "$MSG" | grep -qE '^Merge (pull request|branch|remote-tracking)'; then
    exit 0
fi

# Allow fixup/squash/amend commits (interactive rebase)
if echo "$MSG" | grep -qE '^(fixup|squash|amend)! '; then
    exit 0
fi

# Allow revert commits
if echo "$MSG" | grep -qE '^Revert "'; then
    exit 0
fi

# ── Conventional Commits validation ─────────────────────────────────

TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# Pattern: type: description (no scopes)
# - type is required
# - colon + space after type is required
# - description must start with lowercase letter
PATTERN="^($TYPES): [a-z].*"

if ! echo "$MSG" | grep -qE "$PATTERN"; then
    echo -e "${RED}Error: Invalid commit message format.${NC}"
    echo ""
    echo -e "  Got: ${YELLOW}$MSG${NC}"
    echo ""
    echo -e "Expected: ${GREEN}<type>: <description>${NC}"
    echo ""
    echo -e "  Types: feat fix docs style refactor perf test build ci chore revert"
    echo ""
    echo -e "  Other valid formats:"
    echo -e "    Merge pull request ...       (merge commits)"
    echo -e "    fixup! / squash! / amend!    (rebase commits)"
    echo ""
    echo -e "  Rules:"
    echo -e "    • Description must start with a lowercase letter"
    echo -e "    • Subject line should be ≤ 72 characters"
    echo -e "    • No scopes — use bare ${GREEN}type: description${NC}"
    echo ""
    echo -e "  Examples:"
    echo -e "    ${GREEN}feat: add worktree creation with collision-safe naming${NC}"
    echo -e "    ${GREEN}fix: handle missing branch in remove command${NC}"
    echo -e "    ${GREEN}test: add integration tests for go subcommand${NC}"
    echo -e "    ${GREEN}docs: update shell integration instructions${NC}"
    exit 1
fi

# ── Subject line length check ────────────────────────────────────────

if [ ${#MSG} -gt 72 ]; then
    echo -e "${YELLOW}Warning: Subject line is ${#MSG} characters (recommended max: 72).${NC}"
    echo -e "  ${MSG}"
fi

exit 0
