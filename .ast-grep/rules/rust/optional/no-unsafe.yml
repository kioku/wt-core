# Rule: no-unsafe
# Flags unsafe blocks for review
#
# This rule highlights unsafe code for careful review.
# Unsafe code is sometimes necessary but should be minimized.
#
# Blocks preceded by a "// SAFETY:" comment are considered documented
# and won't trigger this rule.

id: no-unsafe
language: rust
severity: warning
message: "Unsafe block detected. Ensure this is necessary and well-documented with a SAFETY comment."

ignores:
  - "**/tests/**"
  - "**/test_*.rs"
  - "**/*_test.rs"
  - "**/*_tests.rs"
  - "**/benches/**"
  - "**/examples/**"

rule:
  kind: unsafe_block
  not:
    any:
      - follows:
          kind: line_comment
          regex: "SAFETY:"
      - inside:
          stopBy: end
          kind: mod_item
          follows:
            stopBy: end
            pattern: "#[cfg(test)]"

note: |
  Unsafe code requires extra scrutiny. For each unsafe block:

  1. Document invariants with a SAFETY comment:
     // SAFETY: pointer is valid because...
     unsafe { ... }

  2. Minimize the unsafe scope

  3. Consider if there's a safe alternative:
     - Use safe abstractions from std/crates
     - Wrap unsafe in a safe API with clear contracts

  4. Ensure proper testing (Miri, sanitizers)
